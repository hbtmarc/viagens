<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelSync - Planejamento Angra</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%);
        }
        [x-cloak] { display: none!important; }
        
        /* Toast Animation */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(20, 184, 166, 0.4); }
            50% { box-shadow: 0 0 30px rgba(20, 184, 166, 0.6); }
        }
        
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s ease-out;
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Smooth transitions */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #14b8a6, #0d9488);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #0d9488, #0f766e);
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        accent: {
                            50: '#fef3f2',
                            100: '#fee5e2',
                            200: '#fececa',
                            300: '#fdaca5',
                            400: '#fb7c72',
                            500: '#f35b4f',
                            600: '#e03f34',
                            700: '#bc2f25',
                            800: '#9b2b23',
                            900: '#802a24',
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'gradient-ocean': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'gradient-sunset': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'gradient-beach': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'glow': '0 0 20px rgba(20, 184, 166, 0.4)',
                        'glow-accent': '0 0 20px rgba(243, 91, 79, 0.4)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800" x-data="travelApp()">

    <nav class="glass sticky top-0 z-30 shadow-soft border-b border-white/20">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 sm:h-16">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="bg-gradient-to-br from-brand-400 to-brand-600 text-white p-1.5 sm:p-2 rounded-xl shadow-glow">
                        <i class="ph-fill ph-airplane-takeoff text-lg sm:text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-base sm:text-xl tracking-tight gradient-text">TravelSync</h1>
                        <p class="text-[10px] sm:text-xs text-brand-600 font-semibold flex items-center gap-1">
                            <i class="ph-fill ph-map-pin text-[10px]"></i>
                            Angra 2025
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="hidden md:flex -space-x-2 overflow-hidden">
                        <template x-for="member in members" :key="member.id">
                            <div class="relative inline-block h-8 w-8 rounded-full ring-2 ring-white bg-gradient-to-br from-brand-200 to-brand-300 flex items-center justify-center text-xs font-bold text-brand-800 shadow-sm" :title="member.name" x-text="member.initials"></div>
                        </template>
                    </div>
                    <button @click="openAddModal" class="bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 active:scale-95 text-white px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-semibold transition-all flex items-center gap-2 shadow-glow hover:shadow-lg">
                        <i class="ph-bold ph-plus-circle text-sm sm:text-base"></i>
                        <span class="hidden sm:inline">Nova Despesa</span>
                        <span class="sm:hidden">Nova</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8 pb-20 sm:pb-8">
        
        <!-- Tabs Navigation -->
        <div class="flex justify-center mb-6 sm:mb-8">
            <div class="glass p-1.5 rounded-2xl inline-flex shadow-soft w-full max-w-md sm:w-auto border border-white/40">
                <button @click="currentTab = 'traveler'" 
                        :class="currentTab === 'traveler' ? 'bg-gradient-to-r from-brand-500 to-brand-600 text-white shadow-glow' : 'text-slate-600 hover:text-brand-600 hover:bg-white/50'"
                        class="flex-1 sm:flex-none px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl text-xs sm:text-sm font-semibold transition-all duration-200 active:scale-95 flex items-center justify-center gap-1.5">
                    <i class="ph-fill ph-user-circle text-base sm:text-lg"></i>
                    <span>Viajante</span>
                </button>
                <button @click="currentTab = 'general'" 
                        :class="currentTab === 'general' ? 'bg-gradient-to-r from-brand-500 to-brand-600 text-white shadow-glow' : 'text-slate-600 hover:text-brand-600 hover:bg-white/50'"
                        class="flex-1 sm:flex-none px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl text-xs sm:text-sm font-semibold transition-all duration-200 active:scale-95 flex items-center justify-center gap-1.5">
                    <i class="ph-fill ph-chart-line text-base sm:text-lg"></i>
                    <span>Geral</span>
                </button>
            </div>
        </div>

        <!-- General View -->
        <div x-show="currentTab === 'general'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100">
            <div class="max-w-md mx-auto mb-6 sm:mb-8">
                <div class="glass p-6 sm:p-8 rounded-2xl shadow-soft border border-white/40 hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-400/10 to-transparent rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform"></div>
                    <div class="relative z-10 text-center">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <div class="p-3 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl shadow-glow">
                                <i class="ph-fill ph-piggy-bank text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm sm:text-base font-semibold text-emerald-700 mb-2">Custo Total da Viagem</p>
                        <h2 class="text-4xl sm:text-5xl font-bold text-slate-900 mb-2" x-text="formatCurrency(totalCost)"></h2>
                        <p class="text-xs sm:text-sm text-slate-500">Soma de todas as despesas do grupo</p>
                    </div>
                </div>
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <h3 class="text-base sm:text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph ph-receipt"></i> Histórico de Despesas
                    </h3>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="flex items-center bg-white border border-slate-200 rounded-lg p-1 shadow-sm flex-1 sm:flex-none">
                            <button @click="prevMonth()" class="p-1 hover:bg-slate-100 active:bg-slate-200 rounded-md text-slate-500 transition">
                                <i class="ph ph-caret-left text-base sm:text-lg"></i>
                            </button>
                            <span class="flex-1 sm:flex-none px-2 sm:px-3 text-xs sm:text-sm font-medium text-slate-700 capitalize min-w-[100px] sm:min-w-[140px] text-center" x-text="displayMonth"></span>
                            <button @click="nextMonth()" class="p-1 hover:bg-slate-100 active:bg-slate-200 rounded-md text-slate-500 transition">
                                <i class="ph ph-caret-right text-base sm:text-lg"></i>
                            </button>
                        </div>
                        <button @click="goToCurrentMonth()" class="text-[10px] sm:text-xs font-medium text-brand-600 hover:text-brand-700 active:bg-brand-100 hover:bg-brand-50 px-2 sm:px-3 py-1.5 rounded-lg transition border border-brand-200 whitespace-nowrap">
                            Hoje
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <!-- Mobile Card View -->
                    <div class="md:hidden divide-y divide-slate-100">
                        <template x-for="expense in filteredExpenses" :key="expense.id">
                            <div class="p-3 hover:bg-slate-50 transition active:bg-slate-100">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1 pr-3">
                                        <div class="font-medium text-sm text-slate-900" x-text="expense.description"></div>
                                        <div class="text-xs text-slate-400 mt-0.5" x-text="expense.date"></div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-sm text-slate-900" x-text="formatCurrency(expense.amount)"></div>
                                        <span x-show="expense.installments > 1" class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[9px] font-medium bg-purple-100 text-purple-800 mt-1">
                                            <i class="ph ph-credit-card text-[10px]"></i>
                                            <span x-text="expense.installments + 'x'"></span>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                                    <div class="flex items-center gap-2">
                                        <span class="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center text-[8px] font-bold text-slate-600" x-text="getMember(expense.payerId).initials"></span>
                                        <span class="text-xs text-slate-600" x-text="getMember(expense.payerId).name"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click="openEditModal(expense)" class="text-slate-400 hover:text-brand-600 active:text-brand-700 transition p-1">
                                            <i class="ph ph-pencil-simple text-base"></i>
                                        </button>
                                        <button @click="deleteExpense(expense.id)" class="text-slate-400 hover:text-red-500 active:text-red-600 transition p-1">
                                            <i class="ph ph-trash text-base"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex -space-x-1.5 mt-2">
                                    <template x-for="pid in (expense.participants || members.map(m=>m.id))">
                                        <div class="relative inline-block h-5 w-5 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-[8px] font-bold text-slate-500" :title="getMember(pid).name" x-text="getMember(pid).initials"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <div x-show="expenses.length === 0" class="p-8 text-center text-slate-500">
                            <i class="ph ph-receipt-x text-3xl mb-2 opacity-50"></i>
                            <p class="text-xs">Nenhuma despesa registrada</p>
                        </div>
                    </div>
                    
                    <!-- Desktop Table View -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th @click="sortBy('description')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Despesa
                                        <span x-show="sortCol === 'description'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th @click="sortBy('payer')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Pagador
                                        <span x-show="sortCol === 'payer'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th class="px-6 py-4 font-semibold">Dividido</th>
                                    <th @click="sortBy('amount')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Valor
                                        <span x-show="sortCol === 'amount'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th @click="sortBy('installments')" class="px-6 py-4 font-semibold text-center cursor-pointer hover:bg-slate-100 transition select-none">
                                        Parcelas
                                        <span x-show="sortCol === 'installments'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th class="px-6 py-4 font-semibold text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="expense in filteredExpenses" :key="expense.id">
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <div class="font-medium text-slate-900" x-text="expense.description"></div>
                                            <div class="text-xs text-slate-500" x-text="expense.date"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-600" 
                                                      x-text="getMember(expense.payerId).initials"></span>
                                                <span x-text="getMember(expense.payerId).name"></span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex -space-x-2 overflow-hidden">
                                                <template x-for="pid in (expense.participants || members.map(m=>m.id))">
                                                    <div class="relative inline-block h-6 w-6 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-[9px] font-bold text-slate-500" 
                                                         :title="getMember(pid).name" 
                                                         x-text="getMember(pid).initials"></div>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 font-medium text-slate-900" x-text="formatCurrency(expense.amount)"></td>
                                        <td class="px-6 py-4 text-center">
                                            <span x-show="expense.installments > 1" class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                <i class="ph ph-credit-card"></i>
                                                <span x-text="expense.installments + 'x'"></span>
                                            </span>
                                            <span x-show="expense.installments <= 1" class="text-slate-400 text-xs">-</span>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="openEditModal(expense)" class="text-slate-400 hover:text-brand-600 transition mr-2">
                                                <i class="ph ph-pencil-simple text-lg"></i>
                                            </button>
                                            <button @click="deleteExpense(expense.id)" class="text-slate-400 hover:text-red-500 transition">
                                                <i class="ph ph-trash text-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div x-show="expenses.length === 0" class="p-12 text-center text-slate-500">
                            <i class="ph ph-receipt-x text-4xl mb-3 opacity-50"></i>
                            <p>Nenhuma despesa registrada ainda.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4 sm:space-y-6">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-check-circle text-emerald-500"></i> Como Quitar
                    </h3>
                    
                    <div class="space-y-4">
                        <template x-for="debt in simplifiedDebts" :key="debt.id">
                            <div class="p-4 rounded-lg bg-slate-50 border border-slate-100 flex items-center justify-between group hover:border-brand-200 hover:bg-brand-50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold text-xs" x-text="getMember(debt.from).initials"></div>
                                        <span class="text-[10px] font-bold text-slate-500 mt-1" x-text="getMember(debt.from).name"></span>
                                    </div>
                                    <div class="flex flex-col items-center px-2">
                                        <span class="text-xs text-slate-400 mb-1">paga para</span>
                                        <i class="ph ph-arrow-right text-slate-300 group-hover:text-brand-400"></i>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-xs" x-text="getMember(debt.to).initials"></div>
                                        <span class="text-[10px] font-bold text-slate-500 mt-1" x-text="getMember(debt.to).name"></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-slate-900" x-text="formatCurrency(debt.amount)"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="simplifiedDebts.length === 0" class="text-center py-6 text-emerald-600 bg-emerald-50 rounded-lg">
                            <i class="ph ph-confetti text-2xl mb-2"></i>
                            <p class="font-medium">Tudo quitado! Ninguém deve nada.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Balanço Líquido</h3>
                    <div class="space-y-4">
                        <template x-for="member in calculateBalances()" :key="member.id">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full" :class="member.balance >= 0? 'bg-emerald-500' : 'bg-red-500'"></span>
                                        <span x-text="member.name" class="text-slate-600 font-medium"></span>
                                    </div>
                                    <span class="font-bold" 
                                          :class="member.balance >= 0? 'text-emerald-600' : 'text-red-600'"
                                          x-text="(member.balance >= 0? '+' : '') + formatCurrency(member.balance)"></span>
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-400 pl-4">
                                    <span>Pagou: <span class="text-slate-600" x-text="formatCurrency(member.paid)"></span></span>
                                    <span>Consumiu: <span class="text-slate-600" x-text="formatCurrency(member.shouldPay)"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100 text-xs text-slate-400">
                        * Consumiu: Valor da sua parte nas despesas
                    </div>
                </div>

                <!-- Couple Cards -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-users text-purple-500"></i> Como Quitar (Casal)
                    </h3>
                    
                    <div class="space-y-4">
                        <template x-for="debt in simplifiedCoupleDebts" :key="debt.id">
                            <div class="p-4 rounded-lg bg-purple-50 border border-purple-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col items-center">
                                        <span class="text-xs font-bold text-slate-600" x-text="debt.from.name"></span>
                                    </div>
                                    <div class="flex flex-col items-center px-2">
                                        <i class="ph ph-arrow-right text-purple-300"></i>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-xs font-bold text-slate-600" x-text="debt.to.name"></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-slate-900" x-text="formatCurrency(debt.amount)"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="simplifiedCoupleDebts.length === 0" class="text-center py-6 text-purple-600 bg-purple-50 rounded-lg">
                            <i class="ph ph-check-circle text-2xl mb-2"></i>
                            <p class="font-medium">Contas entre casais zeradas!</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Balanço Líquido (Casal)</h3>
                    <div class="space-y-4">
                        <template x-for="couple in calculateCoupleBalances()" :key="couple.id">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full" :class="couple.balance >= 0? 'bg-emerald-500' : 'bg-red-500'"></span>
                                        <span x-text="couple.name" class="text-slate-600 font-medium"></span>
                                    </div>
                                    <span class="font-bold" 
                                          :class="couple.balance >= 0? 'text-emerald-600' : 'text-red-600'"
                                          x-text="(couple.balance >= 0? '+' : '') + formatCurrency(couple.balance)"></span>
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-400 pl-4">
                                    <span>Pagou: <span class="text-slate-600" x-text="formatCurrency(couple.paid)"></span></span>
                                    <span>Consumiu: <span class="text-slate-600" x-text="formatCurrency(couple.shouldPay)"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </div>
        </div> <!-- End General View -->

        <!-- Traveler View -->
        <div x-show="currentTab === 'traveler'" x-cloak x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100">
            
            <!-- Traveler Selector -->
            <div class="mb-6 sm:mb-8">
                <div class="text-center mb-4">
                    <p class="text-brand-600 text-xs sm:text-sm font-semibold flex items-center justify-center gap-2">
                        <i class="ph-fill ph-users-three text-base"></i>
                        Selecione o Viajante
                    </p>
                </div>
                <div class="grid grid-cols-4 gap-2 sm:flex sm:flex-wrap sm:justify-center sm:gap-4">
                    <template x-for="member in members" :key="member.id">
                        <button @click="viewMemberId = member.id"
                                class="flex flex-col items-center gap-1.5 sm:gap-2 p-3 sm:p-4 rounded-2xl transition-all duration-300 active:scale-95 relative overflow-hidden"
                                :class="viewMemberId === member.id ? 'glass-dark shadow-glow transform scale-105 border-2 border-brand-400' : 'glass shadow-soft hover:shadow-md hover:scale-105'">
                            <div class="w-10 h-10 sm:w-14 sm:h-14 rounded-full flex items-center justify-center text-base sm:text-xl font-bold transition-all duration-300 shadow-sm"
                                 :class="viewMemberId === member.id ? 'bg-gradient-to-br from-brand-400 to-brand-600 text-white shadow-glow' : 'bg-gradient-to-br from-slate-100 to-slate-200 text-slate-600 hover:from-brand-50 hover:to-brand-100 hover:text-brand-700'">
                                <span x-text="member.initials"></span>
                            </div>
                            <span class="text-[10px] sm:text-sm font-semibold truncate w-full text-center transition-colors"
                                  :class="viewMemberId === member.id ? 'text-white' : 'text-slate-700'"
                                  x-text="member.name"></span>
                            <div x-show="viewMemberId === member.id" class="absolute inset-0 bg-gradient-to-br from-brand-500/20 to-brand-600/20 pointer-events-none"></div>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Traveler Stats -->
            <div class="max-w-md mx-auto mb-6 sm:mb-8">
                <div class="glass p-6 sm:p-8 rounded-2xl shadow-soft border border-white/40 hover:shadow-md transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-brand-400/10 to-transparent rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform"></div>
                    <div class="relative z-10 text-center">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <div class="p-3 bg-gradient-to-br from-brand-400 to-brand-600 rounded-xl shadow-glow">
                                <i class="ph-fill ph-shopping-cart text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm sm:text-base font-semibold text-brand-700 mb-2">Minha Parte</p>
                        <h2 class="text-4xl sm:text-5xl font-bold text-slate-900 mb-2" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.shouldPay || 0)"></h2>
                        <p class="text-xs sm:text-sm text-slate-500">Total das despesas que participei</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Expenses List -->
            <div class="glass rounded-2xl shadow-soft border border-white/40 overflow-hidden">
                <div class="p-3 sm:p-6 border-b border-white/20 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-base sm:text-lg font-bold text-slate-800 flex items-center gap-2">
                            <div class="p-1.5 bg-gradient-to-br from-brand-400 to-brand-600 rounded-lg">
                                <i class="ph-fill ph-receipt text-white text-sm"></i>
                            </div>
                            Detalhamento
                        </h3>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center glass rounded-xl p-1 shadow-sm flex-1 border border-white/40">
                            <button @click="prevMonth()" class="p-1.5 hover:bg-brand-50 active:bg-brand-100 rounded-lg text-brand-600 transition-all active:scale-95">
                                <i class="ph-bold ph-caret-left text-base sm:text-lg"></i>
                            </button>
                            <span class="flex-1 text-xs sm:text-sm font-semibold text-slate-700 capitalize text-center" x-text="displayMonth"></span>
                            <button @click="nextMonth()" class="p-1.5 hover:bg-brand-50 active:bg-brand-100 rounded-lg text-brand-600 transition-all active:scale-95">
                                <i class="ph-bold ph-caret-right text-base sm:text-lg"></i>
                            </button>
                        </div>
                        <button @click="goToCurrentMonth()" class="text-[10px] sm:text-xs font-semibold text-white bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 active:scale-95 px-2 sm:px-3 py-2 rounded-xl transition-all shadow-sm hover:shadow-md whitespace-nowrap">
                            <i class="ph-bold ph-calendar-check mr-1"></i>Hoje
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Card View -->
                <div class="md:hidden divide-y divide-white/20">
                    <template x-for="expense in filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId))" :key="expense.id">
                        <div class="p-3 hover:bg-white/30 transition-all active:bg-white/40 relative">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm text-slate-900" x-text="expense.description"></div>
                                    <div class="flex items-center gap-1 mt-1">
                                        <i class="ph-fill ph-calendar-blank text-brand-500 text-[10px]"></i>
                                        <span class="text-xs text-slate-500" x-text="expense.date.split('-').reverse().slice(0,2).join('/')"></span>
                                    </div>
                                </div>
                                <div class="text-right ml-2">
                                    <div class="flex items-baseline gap-0.5">
                                        <span class="text-xs text-slate-500">R$</span>
                                        <div class="font-bold text-base text-brand-600" x-text="formatCurrency(parseFloat(expense.amount) / (expense.participants || members.map(m=>m.id)).length).replace('R$', '').trim()"></div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 uppercase tracking-wide">minha parte</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-slate-200">
                                <span class="text-xs text-slate-500 flex items-center gap-1">
                                    <i class="ph-fill ph-currency-circle-dollar text-slate-400"></i>
                                    Total
                                </span>
                                <span class="text-xs text-slate-700 font-semibold" x-text="formatCurrency(expense.amount)"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId)).length === 0" class="p-8 text-center text-slate-500">
                        <i class="ph ph-smiley text-3xl mb-2 opacity-50"></i>
                        <p class="text-xs">Nenhuma despesa neste mês</p>
                    </div>
                    
                    <!-- Mobile Total -->
                    <div class="bg-gradient-to-r from-brand-50 to-brand-100 p-4 font-bold border-t-2 border-brand-300">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-brand-700 uppercase font-semibold flex items-center gap-1">
                                <i class="ph-fill ph-equals text-brand-600"></i>
                                Total do Mês
                            </span>
                            <span class="text-lg text-brand-700" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.shouldPay || 0)"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4 font-semibold">Data</th>
                                <th class="px-6 py-4 font-semibold">Despesa</th>
                                <th class="px-6 py-4 font-semibold">Valor Total</th>
                                <th class="px-6 py-4 font-semibold">Minha Parte</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="expense in filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId))" :key="expense.id">
                                <tr class="hover:bg-slate-50 transition">
                                    <td class="px-6 py-4 text-slate-500" x-text="expense.date.split('-').reverse().slice(0,2).join('/')"></td>
                                    <td class="px-6 py-4 font-medium text-slate-900" x-text="expense.description"></td>
                                    <td class="px-6 py-4 text-slate-500" x-text="formatCurrency(expense.amount)"></td>
                                    <td class="px-6 py-4 font-bold text-slate-900" x-text="formatCurrency(parseFloat(expense.amount) / (expense.participants || members.map(m=>m.id)).length)"></td>
                                </tr>
                            </template>
                            <tr x-show="filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId)).length === 0">
                                <td colspan="4" class="px-6 py-12 text-center text-slate-500">
                                    <i class="ph ph-smiley text-4xl mb-3 opacity-50"></i>
                                    <p>Você não participou de nenhuma despesa neste mês.</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-slate-50 font-bold text-slate-900 border-t border-slate-200">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right uppercase text-xs text-slate-500">Total do Mês</td>
                                <td class="px-6 py-4 text-emerald-600" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.shouldPay || 0)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Toast Container -->
    <div class="fixed top-16 sm:top-20 right-3 sm:right-6 z-50 space-y-2" style="max-width: calc(100vw - 1.5rem);">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast-enter bg-white rounded-lg shadow-lg border-l-4 p-3 sm:p-4 min-w-[280px] max-w-md"
                 :class="{
                     'border-emerald-500': toast.type === 'success',
                     'border-red-500': toast.type === 'error',
                     'border-blue-500': toast.type === 'info'
                 }">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                        <i class="ph-fill text-xl"
                           :class="{
                               'ph-check-circle text-emerald-500': toast.type === 'success',
                               'ph-x-circle text-red-500': toast.type === 'error',
                               'ph-info text-blue-500': toast.type === 'info'
                           }"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-900" x-text="toast.message"></p>
                    </div>
                    <button @click="removeToast(toast.id)" class="flex-shrink-0 text-slate-400 hover:text-slate-600">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <div x-show="showAddModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showAddModal" @click="showAddModal = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showAddModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4" id="modal-title" x-text="editingId ? 'Editar Despesa' : 'Adicionar Nova Despesa'"></h3>
                    
                    <form @submit.prevent="saveExpense" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
                            <input type="text" x-model="newExpense.description" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2" placeholder="Ex: Jantar, Uber...">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Valor (R$)</label>
                                <input type="number" step="0.01" x-model="newExpense.amount" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Quem Pagou?</label>
                                <select x-model="newExpense.payerId" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                                    <template x-for="member in members" :key="member.id">
                                        <option :value="member.id" x-text="member.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Parcelas</label>
                            <select x-model="newExpense.installments" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                                <option value="1">À vista (1x)</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="6">6x</option>
                                <option value="10">10x</option>
                                <option value="12">12x</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Quem divide?</label>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="member in members" :key="member.id">
                                    <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 transition" :class="newExpense.participants.includes(member.id) ? 'border-brand-500 bg-brand-50' : 'border-slate-200'">
                                        <input type="checkbox" :value="member.id" x-model="newExpense.participants" class="rounded text-brand-600 focus:ring-brand-500">
                                        <span class="text-sm font-medium text-slate-700" x-text="member.name"></span>
                                    </label>
                                </template>
                            </div>
                            <p class="text-xs text-slate-500 mt-1" x-show="newExpense.participants.length === 0">Selecione pelo menos um participante.</p>
                        </div>

                        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-brand-600 text-base font-medium text-white hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 sm:col-start-2 sm:text-sm">
                                Salvar
                            </button>
                            <button type="button" @click="showAddModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js';

        // Expor Alpine globalmente para depuração
        window.Alpine = Alpine;

        const firebaseConfig = {
            apiKey: "AIzaSyATwM1e78EtPGLrX6TSgIAnWc4bnBYzYcY",
            authDomain: "viagens-marc35.firebaseapp.com",
            databaseURL: "https://viagens-marc35-default-rtdb.firebaseio.com",
            projectId: "viagens-marc35",
            storageBucket: "viagens-marc35.firebasestorage.app",
            messagingSenderId: "135160280562",
            appId: "1:135160280562:web:5c3866260959a6a8abe76b",
            measurementId: "G-5D2M9WKX44"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        Alpine.data('travelApp', () => ({
            showAddModal: false,
            editingId: null,
            currentTab: 'traveler',
            viewMemberId: '1',
            toasts: [],
            
            members: [
                { id: '1', name: 'Marcelino', initials: 'MA' },
                { id: '2', name: 'Luiza', initials: 'LU' },
                { id: '3', name: 'Marney', initials: 'MN' },
                { id: '4', name: 'Giovana', initials: 'GI' }
            ],
            
            expenses: [],
            selectedMonth: new Date().toISOString().slice(0, 7),
            sortCol: 'description',
            sortAsc: true,

            newExpense: {
                description: '',
                amount: '',
                payerId: '1',
                installments: '1',
                participants: []
            },

            init() {
                // Initialize participants with all members
                this.newExpense.participants = this.members.map(m => m.id);
                
                console.log("Iniciando TravelApp...");
                const expensesRef = ref(db, 'expenses');
                
                onValue(expensesRef, (snapshot) => {
                    console.log("Recebendo atualização do Firebase...");
                    const data = snapshot.val();
                    if (snapshot.exists() && data) {
                        console.log("Dados carregados:", data);
                        this.expenses = Object.values(data);
                    } else {
                        this.expenses = [];
                    }
                }, (error) => {
                    console.error("Erro de permissão ou conexão:", error);
                    alert("Erro ao conectar ao Firebase: " + error.message + "\n\nVerifique se as 'Regras' (Rules) do Realtime Database estão permitindo leitura/escrita.");
                });
            },

            // Navigation Methods
            prevMonth() {
                let d = new Date(this.selectedMonth + '-02');
                d.setMonth(d.getMonth() - 1);
                this.selectedMonth = d.toISOString().slice(0, 7);
            },
            
            nextMonth() {
                let d = new Date(this.selectedMonth + '-02');
                d.setMonth(d.getMonth() + 1);
                this.selectedMonth = d.toISOString().slice(0, 7);
            },

            goToCurrentMonth() {
                this.selectedMonth = new Date().toISOString().slice(0, 7);
            },

            get displayMonth() {
                if (!this.selectedMonth) return '';
                const [year, month] = this.selectedMonth.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, 2);
                return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            },

            sortBy(col) {
                if (this.sortCol === col) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortCol = col;
                    this.sortAsc = true;
                }
            },

            get filteredExpenses() {
                if (!this.selectedMonth) return this.expenses;
                
                const targetYear = parseInt(this.selectedMonth.split('-')[0]);
                const targetMonth = parseInt(this.selectedMonth.split('-')[1]) - 1;

                let result = [];

                this.expenses.forEach(expense => {
                    const installments = parseInt(expense.installments || 1);
                    const expParts = expense.date.split('-');
                    const expYear = parseInt(expParts[0]);
                    const expMonth = parseInt(expParts[1]) - 1;

                    if (installments === 1) {
                        if (expense.date.startsWith(this.selectedMonth)) {
                            result.push(expense);
                        }
                    } else {
                        const diff = (targetYear - expYear) * 12 + (targetMonth - expMonth);
                        
                        if (diff >= 0 && diff < installments) {
                            let virtual = { ...expense };
                            virtual.amount = parseFloat(expense.amount) / installments;
                            virtual.description = `${expense.description} (${diff + 1}/${installments})`;
                            virtual.date = `${this.selectedMonth}-${expParts[2]}`; 
                            result.push(virtual);
                        }
                    }
                });
                
                return result.sort((a, b) => {
                    let valA, valB;

                    if (this.sortCol === 'description') {
                        valA = a.description.toLowerCase();
                        valB = b.description.toLowerCase();
                    } else if (this.sortCol === 'payer') {
                        valA = this.getMember(a.payerId).name;
                        valB = this.getMember(b.payerId).name;
                    } else if (this.sortCol === 'amount') {
                        valA = parseFloat(a.amount);
                        valB = parseFloat(b.amount);
                    } else if (this.sortCol === 'installments') {
                        valA = parseInt(a.installments || 1);
                        valB = parseInt(b.installments || 1);
                    } else {
                        valA = a.date;
                        valB = b.date;
                    }

                    if (valA < valB) return this.sortAsc ? -1 : 1;
                    if (valA > valB) return this.sortAsc ? 1 : -1;
                    return 0;
                });
            },

            get totalCost() {
                return this.filteredExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            },

            get perPersonShare() {
                // Deprecated concept with variable splitting, but kept for legacy reference if needed
                return this.totalCost / this.members.length;
            },

            getMember(id) {
                return this.members.find(m => m.id === id) || { name: 'Desconhecido', initials: '?' };
            },

            saveExpense() {
                if (this.newExpense.participants.length === 0) {
                    alert("Selecione pelo menos um participante para dividir a despesa.");
                    return;
                }

                const id = this.editingId || Date.now();
                
                let date;
                if (this.editingId) {
                    date = this.expenses.find(e => e.id === this.editingId)?.date;
                }
                
                if (!date) {
                    if (this.selectedMonth) {
                         const today = new Date();
                         const [year, month] = this.selectedMonth.split('-');
                         let day = today.getDate();
                         const daysInMonth = new Date(year, month, 0).getDate();
                         if (day > daysInMonth) day = daysInMonth;
                         
                         date = `${this.selectedMonth}-${String(day).padStart(2, '0')}`;
                    } else {
                        date = new Date().toISOString().split('T')[0];
                    }
                }

                const expenseData = {
                    id: id,
                    description: this.newExpense.description,
                    amount: parseFloat(this.newExpense.amount),
                    payerId: this.newExpense.payerId,
                    installments: parseInt(this.newExpense.installments),
                    participants: this.newExpense.participants,
                    date: date
                };

                set(ref(db, 'expenses/' + id), expenseData)
                    .then(() => {
                        this.showAddModal = false;
                        this.resetForm();
                        this.showToast(this.editingId ? 'Despesa atualizada com sucesso!' : 'Despesa adicionada com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar: ", error);
                        this.showToast('Erro ao salvar despesa. Tente novamente.', 'error');
                    });
            },

            openAddModal() {
                this.resetForm();
                this.showAddModal = true;
            },

            openEditModal(expense) {
                const original = this.expenses.find(e => e.id === expense.id);
                if (!original) return;

                this.editingId = original.id;
                this.newExpense = {
                    description: original.description,
                    amount: original.amount,
                    payerId: original.payerId,
                    installments: original.installments,
                    participants: original.participants || this.members.map(m => m.id)
                };
                this.showAddModal = true;
            },

            deleteExpense(id) {
                if(confirm('Tem certeza que deseja apagar esta despesa? (Isso apagará todas as parcelas)')) {
                    remove(ref(db, 'expenses/' + id))
                        .then(() => {
                            this.showToast('Despesa removida com sucesso!', 'success');
                        })
                        .catch((error) => {
                            console.error("Erro ao apagar: ", error);
                            this.showToast('Erro ao apagar despesa. Tente novamente.', 'error');
                        });
                }
            },

            resetForm() {
                this.editingId = null;
                this.newExpense = { 
                    description: '', 
                    amount: '', 
                    payerId: '1', 
                    installments: '1',
                    participants: this.members.map(m => m.id)
                };
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            },

            showToast(message, type = 'success') {
                const id = Date.now();
                this.toasts.push({ id, message, type });
                setTimeout(() => this.removeToast(id), 4000);
            },

            removeToast(id) {
                this.toasts = this.toasts.filter(t => t.id !== id);
            },

            calculateBalances() {
                // Inicializar saldos
                let balances = this.members.map(m => ({ ...m, paid: 0, shouldPay: 0, balance: 0 }));

                this.filteredExpenses.forEach(expense => {
                    const amount = parseFloat(expense.amount);
                    const payerId = expense.payerId;
                    
                    // Se não tiver participants (legado), assume todos
                    const participants = expense.participants || this.members.map(m => m.id);
                    
                    // Quem pagou recebe crédito
                    const payer = balances.find(b => b.id === payerId);
                    if (payer) payer.paid += amount;

                    // Quem participa gera débito
                    if (participants.length > 0) {
                        const splitAmount = amount / participants.length;
                        participants.forEach(participantId => {
                            const participant = balances.find(b => b.id === participantId);
                            if (participant) participant.shouldPay += splitAmount;
                        });
                    }
                });

                // Calcular saldo final (Pagou - Deve Pagar)
                balances.forEach(b => {
                    b.balance = b.paid - b.shouldPay;
                });

                return balances.sort((a, b) => b.balance - a.balance);
            },

            calculateCoupleBalances() {
                const individualBalances = this.calculateBalances();
                
                const couples = [
                    { id: 'c1', name: 'Marcelino & Luiza', members: ['1', '2'], balance: 0, paid: 0, shouldPay: 0 },
                    { id: 'c2', name: 'Marney & Giovana', members: ['3', '4'], balance: 0, paid: 0, shouldPay: 0 }
                ];

                couples.forEach(couple => {
                    couple.members.forEach(memberId => {
                        const member = individualBalances.find(m => m.id === memberId);
                        if (member) {
                            couple.balance += member.balance;
                            couple.paid += member.paid;
                            couple.shouldPay += member.shouldPay;
                        }
                    });
                });

                return couples.sort((a, b) => b.balance - a.balance);
            },

            get simplifiedCoupleDebts() {
                let balances = this.calculateCoupleBalances().map(c => ({...c}));
                let transactions = [];
                
                let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
                let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);
                
                let i = 0; 
                let j = 0;

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];

                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);

                    if (amount > 0.01) {
                        transactions.push({
                            id: 'couple-' + Date.now() + i + j,
                            from: debtor,
                            to: creditor,
                            amount: amount
                        });
                    }

                    debtor.balance += amount;
                    creditor.balance -= amount;

                    if (Math.abs(debtor.balance) < 0.01) i++;
                    if (creditor.balance < 0.01) j++;
                }
                
                return transactions;
            },

            // O Algoritmo "Greedy" de Simplificação de Dívidas
            get simplifiedDebts() {
                let balances = this.calculateBalances().map(m => ({...m})); // Clone profundo
                let transactions = [];

                // Separar devedores e credores
                let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
                let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);

                    let i = 0; // Índice devedor
                    let j = 0; // Índice credor

                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];

                        // O valor a transferir é o mínimo entre o que deve e o que tem a receber
                        let amount = Math.min(Math.abs(debtor.balance), creditor.balance);

                        // Registrar transação
                        if (amount > 0.01) {
                            transactions.push({
                                id: Date.now() + i + j,
                                from: debtor.id,
                                to: creditor.id,
                                amount: amount
                            });
                        }

                        // Atualizar saldos temporários
                        debtor.balance += amount;
                        creditor.balance -= amount;

                        // Avançar índices se liquidado
                        if (Math.abs(debtor.balance) < 0.01) i++;
                        if (creditor.balance < 0.01) j++;
                    }

                    return transactions;
                }
            }));

            Alpine.start();
    </script>
</body>
</html>