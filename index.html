<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelSync - Planejamento Angra</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none!important; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800" x-data="travelApp()">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 text-white p-2 rounded-lg">
                        <i class="ph ph-airplane-tilt text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl tracking-tight text-slate-900">TravelSync</h1>
                        <p class="text-xs text-slate-500 font-medium">Projeto Angra 2025</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex -space-x-2 overflow-hidden">
                        <template x-for="member in members" :key="member.id">
                            <div class="relative inline-block h-8 w-8 rounded-full ring-2 ring-white bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-600" :title="member.name" x-text="member.initials"></div>
                        </template>
                    </div>
                    <button @click="openAddModal" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
                        <i class="ph ph-plus-bold"></i> <span class="hidden sm:inline">Nova Despesa</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Tabs Navigation -->
        <div class="flex justify-center mb-8">
            <div class="bg-slate-100 p-1 rounded-xl inline-flex shadow-inner">
                <button @click="currentTab = 'traveler'" 
                        :class="currentTab === 'traveler' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200">
                    Visão por Viajante
                </button>
                <button @click="currentTab = 'general'" 
                        :class="currentTab === 'general' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200">
                    Visão Geral
                </button>
            </div>
        </div>

        <!-- General View -->
        <div x-show="currentTab === 'general'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">Custo Total da Viagem</p>
                    <h2 class="text-3xl font-bold text-slate-900" x-text="formatCurrency(totalCost)"></h2>
                </div>
                <div class="h-12 w-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600">
                    <i class="ph ph-currency-dollar text-2xl"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">Média de Gastos</p>
                    <h2 class="text-3xl font-bold text-brand-600" x-text="formatCurrency(totalCost / members.length)"></h2>
                </div>
                <div class="h-12 w-12 bg-brand-50 rounded-full flex items-center justify-center text-brand-600">
                    <i class="ph ph-chart-bar text-2xl"></i>
                </div>
            </div>

            <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-sm font-medium text-slate-300 mb-1">Transações Necessárias</p>
                    <h2 class="text-3xl font-bold" x-text="simplifiedDebts.length"></h2>
                    <p class="text-xs text-slate-400 mt-1">Para zerar todas as dívidas</p>
                </div>
                <i class="ph ph-arrows-left-right absolute right-4 bottom-4 text-6xl text-slate-800 opacity-50"></i>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph ph-receipt"></i> Histórico de Despesas
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center bg-white border border-slate-200 rounded-lg p-1 shadow-sm">
                            <button @click="prevMonth()" class="p-1 hover:bg-slate-100 rounded-md text-slate-500 transition">
                                <i class="ph ph-caret-left text-lg"></i>
                            </button>
                            <span class="px-3 text-sm font-medium text-slate-700 capitalize min-w-[140px] text-center" x-text="displayMonth"></span>
                            <button @click="nextMonth()" class="p-1 hover:bg-slate-100 rounded-md text-slate-500 transition">
                                <i class="ph ph-caret-right text-lg"></i>
                            </button>
                        </div>
                        <button @click="goToCurrentMonth()" class="text-xs font-medium text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition border border-brand-200">
                            Mês Atual
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th @click="sortBy('description')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Despesa
                                        <span x-show="sortCol === 'description'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th @click="sortBy('payer')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Pagador
                                        <span x-show="sortCol === 'payer'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th class="px-6 py-4 font-semibold">Dividido</th>
                                    <th @click="sortBy('amount')" class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 transition select-none">
                                        Valor
                                        <span x-show="sortCol === 'amount'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th @click="sortBy('installments')" class="px-6 py-4 font-semibold text-center cursor-pointer hover:bg-slate-100 transition select-none">
                                        Parcelas
                                        <span x-show="sortCol === 'installments'" x-text="sortAsc ? '↑' : '↓'" class="ml-1"></span>
                                    </th>
                                    <th class="px-6 py-4 font-semibold text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="expense in filteredExpenses" :key="expense.id">
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <div class="font-medium text-slate-900" x-text="expense.description"></div>
                                            <div class="text-xs text-slate-500" x-text="expense.date"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-600" 
                                                      x-text="getMember(expense.payerId).initials"></span>
                                                <span x-text="getMember(expense.payerId).name"></span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex -space-x-2 overflow-hidden">
                                                <template x-for="pid in (expense.participants || members.map(m=>m.id))">
                                                    <div class="relative inline-block h-6 w-6 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-[9px] font-bold text-slate-500" 
                                                         :title="getMember(pid).name" 
                                                         x-text="getMember(pid).initials"></div>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 font-medium text-slate-900" x-text="formatCurrency(expense.amount)"></td>
                                        <td class="px-6 py-4 text-center">
                                            <span x-show="expense.installments > 1" class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                <i class="ph ph-credit-card"></i>
                                                <span x-text="expense.installments + 'x'"></span>
                                            </span>
                                            <span x-show="expense.installments <= 1" class="text-slate-400 text-xs">-</span>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="openEditModal(expense)" class="text-slate-400 hover:text-brand-600 transition mr-2">
                                                <i class="ph ph-pencil-simple text-lg"></i>
                                            </button>
                                            <button @click="deleteExpense(expense.id)" class="text-slate-400 hover:text-red-500 transition">
                                                <i class="ph ph-trash text-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="expenses.length === 0" class="p-12 text-center text-slate-500">
                        <i class="ph ph-receipt-x text-4xl mb-3 opacity-50"></i>
                        <p>Nenhuma despesa registrada ainda.</p>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-check-circle text-emerald-500"></i> Como Quitar
                    </h3>
                    
                    <div class="space-y-4">
                        <template x-for="debt in simplifiedDebts" :key="debt.id">
                            <div class="p-4 rounded-lg bg-slate-50 border border-slate-100 flex items-center justify-between group hover:border-brand-200 hover:bg-brand-50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold text-xs" x-text="getMember(debt.from).initials"></div>
                                        <span class="text-[10px] font-bold text-slate-500 mt-1" x-text="getMember(debt.from).name"></span>
                                    </div>
                                    <div class="flex flex-col items-center px-2">
                                        <span class="text-xs text-slate-400 mb-1">paga para</span>
                                        <i class="ph ph-arrow-right text-slate-300 group-hover:text-brand-400"></i>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-xs" x-text="getMember(debt.to).initials"></div>
                                        <span class="text-[10px] font-bold text-slate-500 mt-1" x-text="getMember(debt.to).name"></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-slate-900" x-text="formatCurrency(debt.amount)"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="simplifiedDebts.length === 0" class="text-center py-6 text-emerald-600 bg-emerald-50 rounded-lg">
                            <i class="ph ph-confetti text-2xl mb-2"></i>
                            <p class="font-medium">Tudo quitado! Ninguém deve nada.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Balanço Líquido</h3>
                    <div class="space-y-4">
                        <template x-for="member in calculateBalances()" :key="member.id">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full" :class="member.balance >= 0? 'bg-emerald-500' : 'bg-red-500'"></span>
                                        <span x-text="member.name" class="text-slate-600 font-medium"></span>
                                    </div>
                                    <span class="font-bold" 
                                          :class="member.balance >= 0? 'text-emerald-600' : 'text-red-600'"
                                          x-text="(member.balance >= 0? '+' : '') + formatCurrency(member.balance)"></span>
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-400 pl-4">
                                    <span>Pagou: <span class="text-slate-600" x-text="formatCurrency(member.paid)"></span></span>
                                    <span>Consumiu: <span class="text-slate-600" x-text="formatCurrency(member.shouldPay)"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100 text-xs text-slate-400">
                        * Consumiu: Valor da sua parte nas despesas
                    </div>
                </div>

                <!-- Couple Cards -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-users text-purple-500"></i> Como Quitar (Casal)
                    </h3>
                    
                    <div class="space-y-4">
                        <template x-for="debt in simplifiedCoupleDebts" :key="debt.id">
                            <div class="p-4 rounded-lg bg-purple-50 border border-purple-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col items-center">
                                        <span class="text-xs font-bold text-slate-600" x-text="debt.from.name"></span>
                                    </div>
                                    <div class="flex flex-col items-center px-2">
                                        <i class="ph ph-arrow-right text-purple-300"></i>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-xs font-bold text-slate-600" x-text="debt.to.name"></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-slate-900" x-text="formatCurrency(debt.amount)"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="simplifiedCoupleDebts.length === 0" class="text-center py-6 text-purple-600 bg-purple-50 rounded-lg">
                            <i class="ph ph-check-circle text-2xl mb-2"></i>
                            <p class="font-medium">Contas entre casais zeradas!</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Balanço Líquido (Casal)</h3>
                    <div class="space-y-4">
                        <template x-for="couple in calculateCoupleBalances()" :key="couple.id">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full" :class="couple.balance >= 0? 'bg-emerald-500' : 'bg-red-500'"></span>
                                        <span x-text="couple.name" class="text-slate-600 font-medium"></span>
                                    </div>
                                    <span class="font-bold" 
                                          :class="couple.balance >= 0? 'text-emerald-600' : 'text-red-600'"
                                          x-text="(couple.balance >= 0? '+' : '') + formatCurrency(couple.balance)"></span>
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-400 pl-4">
                                    <span>Pagou: <span class="text-slate-600" x-text="formatCurrency(couple.paid)"></span></span>
                                    <span>Consumiu: <span class="text-slate-600" x-text="formatCurrency(couple.shouldPay)"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </div>
        </div> <!-- End General View -->

        <!-- Traveler View -->
        <div x-show="currentTab === 'traveler'" x-cloak x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100">
            
            <!-- Traveler Selector -->
            <div class="mb-8">
                <p class="text-center text-slate-500 text-sm mb-4 font-medium">Selecione o Viajante</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <template x-for="member in members" :key="member.id">
                        <button @click="viewMemberId = member.id"
                                class="flex flex-col items-center gap-2 p-4 rounded-xl transition-all duration-200 w-24"
                                :class="viewMemberId === member.id ? 'bg-brand-50 border-2 border-brand-500 shadow-sm transform scale-105' : 'bg-white border border-slate-200 hover:border-brand-200 hover:bg-slate-50'">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold transition-colors"
                                 :class="viewMemberId === member.id ? 'bg-brand-100 text-brand-700' : 'bg-slate-100 text-slate-500'">
                                <span x-text="member.initials"></span>
                            </div>
                            <span class="text-sm font-medium truncate w-full text-center"
                                  :class="viewMemberId === member.id ? 'text-brand-700' : 'text-slate-600'"
                                  x-text="member.name"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Traveler Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Minha Parte (Consumo)</p>
                    <h2 class="text-3xl font-bold text-slate-900" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.shouldPay || 0)"></h2>
                    <p class="text-xs text-slate-400 mt-1">Valor das despesas que participei</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Eu Paguei</p>
                    <h2 class="text-3xl font-bold text-emerald-600" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.paid || 0)"></h2>
                    <p class="text-xs text-slate-400 mt-1">Valor total desembolsado</p>
                </div>

                <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-300 mb-1">Meu Saldo</p>
                        <h2 class="text-3xl font-bold" 
                            :class="(calculateBalances().find(m => m.id === viewMemberId)?.balance || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'"
                            x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.balance || 0)"></h2>
                        <p class="text-xs text-slate-400 mt-1" x-text="(calculateBalances().find(m => m.id === viewMemberId)?.balance || 0) >= 0 ? 'A receber' : 'A pagar'"></p>
                    </div>
                </div>
            </div>

            <!-- Detailed Expenses List -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph ph-list-dashes"></i> Detalhamento da Fatura
                    </h3>
                    <span class="text-sm text-slate-500" x-text="displayMonth"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4 font-semibold">Data</th>
                                <th class="px-6 py-4 font-semibold">Despesa</th>
                                <th class="px-6 py-4 font-semibold">Valor Total</th>
                                <th class="px-6 py-4 font-semibold">Minha Parte</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="expense in filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId))" :key="expense.id">
                                <tr class="hover:bg-slate-50 transition">
                                    <td class="px-6 py-4 text-slate-500" x-text="expense.date.split('-').reverse().slice(0,2).join('/')"></td>
                                    <td class="px-6 py-4 font-medium text-slate-900" x-text="expense.description"></td>
                                    <td class="px-6 py-4 text-slate-500" x-text="formatCurrency(expense.amount)"></td>
                                    <td class="px-6 py-4 font-bold text-slate-900" x-text="formatCurrency(parseFloat(expense.amount) / (expense.participants || members.map(m=>m.id)).length)"></td>
                                </tr>
                            </template>
                            <tr x-show="filteredExpenses.filter(e => (e.participants || members.map(m=>m.id)).includes(viewMemberId)).length === 0">
                                <td colspan="4" class="px-6 py-12 text-center text-slate-500">
                                    <i class="ph ph-smiley text-4xl mb-3 opacity-50"></i>
                                    <p>Você não participou de nenhuma despesa neste mês.</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-slate-50 font-bold text-slate-900 border-t border-slate-200">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right uppercase text-xs text-slate-500">Total do Mês</td>
                                <td class="px-6 py-4 text-emerald-600" x-text="formatCurrency(calculateBalances().find(m => m.id === viewMemberId)?.shouldPay || 0)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div x-show="showAddModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showAddModal" @click="showAddModal = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showAddModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-4" id="modal-title" x-text="editingId ? 'Editar Despesa' : 'Adicionar Nova Despesa'"></h3>
                    
                    <form @submit.prevent="saveExpense" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
                            <input type="text" x-model="newExpense.description" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2" placeholder="Ex: Jantar, Uber...">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Valor (R$)</label>
                                <input type="number" step="0.01" x-model="newExpense.amount" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Quem Pagou?</label>
                                <select x-model="newExpense.payerId" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                                    <template x-for="member in members" :key="member.id">
                                        <option :value="member.id" x-text="member.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Parcelas</label>
                            <select x-model="newExpense.installments" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 border p-2">
                                <option value="1">À vista (1x)</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="6">6x</option>
                                <option value="10">10x</option>
                                <option value="12">12x</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Quem divide?</label>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="member in members" :key="member.id">
                                    <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 transition" :class="newExpense.participants.includes(member.id) ? 'border-brand-500 bg-brand-50' : 'border-slate-200'">
                                        <input type="checkbox" :value="member.id" x-model="newExpense.participants" class="rounded text-brand-600 focus:ring-brand-500">
                                        <span class="text-sm font-medium text-slate-700" x-text="member.name"></span>
                                    </label>
                                </template>
                            </div>
                            <p class="text-xs text-slate-500 mt-1" x-show="newExpense.participants.length === 0">Selecione pelo menos um participante.</p>
                        </div>

                        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-brand-600 text-base font-medium text-white hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 sm:col-start-2 sm:text-sm">
                                Salvar
                            </button>
                            <button type="button" @click="showAddModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js';

        // Expor Alpine globalmente para depuração
        window.Alpine = Alpine;

        const firebaseConfig = {
            apiKey: "AIzaSyATwM1e78EtPGLrX6TSgIAnWc4bnBYzYcY",
            authDomain: "viagens-marc35.firebaseapp.com",
            databaseURL: "https://viagens-marc35-default-rtdb.firebaseio.com",
            projectId: "viagens-marc35",
            storageBucket: "viagens-marc35.firebasestorage.app",
            messagingSenderId: "135160280562",
            appId: "1:135160280562:web:5c3866260959a6a8abe76b",
            measurementId: "G-5D2M9WKX44"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        Alpine.data('travelApp', () => ({
            showAddModal: false,
            editingId: null,
            currentTab: 'traveler',
            viewMemberId: '1',
            
            members: [
                { id: '1', name: 'Marcelino', initials: 'MA' },
                { id: '2', name: 'Luiza', initials: 'LU' },
                { id: '3', name: 'Marney', initials: 'MN' },
                { id: '4', name: 'Giovana', initials: 'GI' }
            ],
            
            expenses: [],
            selectedMonth: new Date().toISOString().slice(0, 7),
            sortCol: 'description',
            sortAsc: true,

            newExpense: {
                description: '',
                amount: '',
                payerId: '1',
                installments: '1',
                participants: []
            },

            init() {
                // Initialize participants with all members
                this.newExpense.participants = this.members.map(m => m.id);
                
                console.log("Iniciando TravelApp...");
                const expensesRef = ref(db, 'expenses');
                
                onValue(expensesRef, (snapshot) => {
                    console.log("Recebendo atualização do Firebase...");
                    const data = snapshot.val();
                    if (snapshot.exists() && data) {
                        console.log("Dados carregados:", data);
                        this.expenses = Object.values(data);
                    } else {
                        this.expenses = [];
                    }
                }, (error) => {
                    console.error("Erro de permissão ou conexão:", error);
                    alert("Erro ao conectar ao Firebase: " + error.message + "\n\nVerifique se as 'Regras' (Rules) do Realtime Database estão permitindo leitura/escrita.");
                });
            },

            // Navigation Methods
            prevMonth() {
                let d = new Date(this.selectedMonth + '-02');
                d.setMonth(d.getMonth() - 1);
                this.selectedMonth = d.toISOString().slice(0, 7);
            },
            
            nextMonth() {
                let d = new Date(this.selectedMonth + '-02');
                d.setMonth(d.getMonth() + 1);
                this.selectedMonth = d.toISOString().slice(0, 7);
            },

            goToCurrentMonth() {
                this.selectedMonth = new Date().toISOString().slice(0, 7);
            },

            get displayMonth() {
                if (!this.selectedMonth) return '';
                const [year, month] = this.selectedMonth.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, 2);
                return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            },

            sortBy(col) {
                if (this.sortCol === col) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortCol = col;
                    this.sortAsc = true;
                }
            },

            get filteredExpenses() {
                if (!this.selectedMonth) return this.expenses;
                
                const targetYear = parseInt(this.selectedMonth.split('-')[0]);
                const targetMonth = parseInt(this.selectedMonth.split('-')[1]) - 1;

                let result = [];

                this.expenses.forEach(expense => {
                    const installments = parseInt(expense.installments || 1);
                    const expParts = expense.date.split('-');
                    const expYear = parseInt(expParts[0]);
                    const expMonth = parseInt(expParts[1]) - 1;

                    if (installments === 1) {
                        if (expense.date.startsWith(this.selectedMonth)) {
                            result.push(expense);
                        }
                    } else {
                        const diff = (targetYear - expYear) * 12 + (targetMonth - expMonth);
                        
                        if (diff >= 0 && diff < installments) {
                            let virtual = { ...expense };
                            virtual.amount = parseFloat(expense.amount) / installments;
                            virtual.description = `${expense.description} (${diff + 1}/${installments})`;
                            virtual.date = `${this.selectedMonth}-${expParts[2]}`; 
                            result.push(virtual);
                        }
                    }
                });
                
                return result.sort((a, b) => {
                    let valA, valB;

                    if (this.sortCol === 'description') {
                        valA = a.description.toLowerCase();
                        valB = b.description.toLowerCase();
                    } else if (this.sortCol === 'payer') {
                        valA = this.getMember(a.payerId).name;
                        valB = this.getMember(b.payerId).name;
                    } else if (this.sortCol === 'amount') {
                        valA = parseFloat(a.amount);
                        valB = parseFloat(b.amount);
                    } else if (this.sortCol === 'installments') {
                        valA = parseInt(a.installments || 1);
                        valB = parseInt(b.installments || 1);
                    } else {
                        valA = a.date;
                        valB = b.date;
                    }

                    if (valA < valB) return this.sortAsc ? -1 : 1;
                    if (valA > valB) return this.sortAsc ? 1 : -1;
                    return 0;
                });
            },

            get totalCost() {
                return this.filteredExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            },

            get perPersonShare() {
                // Deprecated concept with variable splitting, but kept for legacy reference if needed
                return this.totalCost / this.members.length;
            },

            getMember(id) {
                return this.members.find(m => m.id === id) || { name: 'Desconhecido', initials: '?' };
            },

            saveExpense() {
                if (this.newExpense.participants.length === 0) {
                    alert("Selecione pelo menos um participante para dividir a despesa.");
                    return;
                }

                const id = this.editingId || Date.now();
                
                let date;
                if (this.editingId) {
                    date = this.expenses.find(e => e.id === this.editingId)?.date;
                }
                
                if (!date) {
                    if (this.selectedMonth) {
                         const today = new Date();
                         const [year, month] = this.selectedMonth.split('-');
                         let day = today.getDate();
                         const daysInMonth = new Date(year, month, 0).getDate();
                         if (day > daysInMonth) day = daysInMonth;
                         
                         date = `${this.selectedMonth}-${String(day).padStart(2, '0')}`;
                    } else {
                        date = new Date().toISOString().split('T')[0];
                    }
                }

                const expenseData = {
                    id: id,
                    description: this.newExpense.description,
                    amount: parseFloat(this.newExpense.amount),
                    payerId: this.newExpense.payerId,
                    installments: parseInt(this.newExpense.installments),
                    participants: this.newExpense.participants,
                    date: date
                };

                set(ref(db, 'expenses/' + id), expenseData)
                    .then(() => {
                        this.showAddModal = false;
                        this.resetForm();
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar: ", error);
                        alert("Erro ao salvar despesa.");
                    });
            },

            openAddModal() {
                this.resetForm();
                this.showAddModal = true;
            },

            openEditModal(expense) {
                const original = this.expenses.find(e => e.id === expense.id);
                if (!original) return;

                this.editingId = original.id;
                this.newExpense = {
                    description: original.description,
                    amount: original.amount,
                    payerId: original.payerId,
                    installments: original.installments,
                    participants: original.participants || this.members.map(m => m.id)
                };
                this.showAddModal = true;
            },

            deleteExpense(id) {
                if(confirm('Tem certeza que deseja apagar esta despesa? (Isso apagará todas as parcelas)')) {
                    remove(ref(db, 'expenses/' + id))
                        .catch((error) => {
                            console.error("Erro ao apagar: ", error);
                            alert("Erro ao apagar despesa.");
                        });
                }
            },

            resetForm() {
                this.editingId = null;
                this.newExpense = { 
                    description: '', 
                    amount: '', 
                    payerId: '1', 
                    installments: '1',
                    participants: this.members.map(m => m.id)
                };
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            },

            calculateBalances() {
                // Inicializar saldos
                let balances = this.members.map(m => ({ ...m, paid: 0, shouldPay: 0, balance: 0 }));

                this.filteredExpenses.forEach(expense => {
                    const amount = parseFloat(expense.amount);
                    const payerId = expense.payerId;
                    
                    // Se não tiver participants (legado), assume todos
                    const participants = expense.participants || this.members.map(m => m.id);
                    
                    // Quem pagou recebe crédito
                    const payer = balances.find(b => b.id === payerId);
                    if (payer) payer.paid += amount;

                    // Quem participa gera débito
                    if (participants.length > 0) {
                        const splitAmount = amount / participants.length;
                        participants.forEach(participantId => {
                            const participant = balances.find(b => b.id === participantId);
                            if (participant) participant.shouldPay += splitAmount;
                        });
                    }
                });

                // Calcular saldo final (Pagou - Deve Pagar)
                balances.forEach(b => {
                    b.balance = b.paid - b.shouldPay;
                });

                return balances.sort((a, b) => b.balance - a.balance);
            },

            calculateCoupleBalances() {
                const individualBalances = this.calculateBalances();
                
                const couples = [
                    { id: 'c1', name: 'Marcelino & Luiza', members: ['1', '2'], balance: 0, paid: 0, shouldPay: 0 },
                    { id: 'c2', name: 'Marney & Giovana', members: ['3', '4'], balance: 0, paid: 0, shouldPay: 0 }
                ];

                couples.forEach(couple => {
                    couple.members.forEach(memberId => {
                        const member = individualBalances.find(m => m.id === memberId);
                        if (member) {
                            couple.balance += member.balance;
                            couple.paid += member.paid;
                            couple.shouldPay += member.shouldPay;
                        }
                    });
                });

                return couples.sort((a, b) => b.balance - a.balance);
            },

            get simplifiedCoupleDebts() {
                let balances = this.calculateCoupleBalances().map(c => ({...c}));
                let transactions = [];
                
                let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
                let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);
                
                let i = 0; 
                let j = 0;

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];

                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);

                    if (amount > 0.01) {
                        transactions.push({
                            id: 'couple-' + Date.now() + i + j,
                            from: debtor,
                            to: creditor,
                            amount: amount
                        });
                    }

                    debtor.balance += amount;
                    creditor.balance -= amount;

                    if (Math.abs(debtor.balance) < 0.01) i++;
                    if (creditor.balance < 0.01) j++;
                }
                
                return transactions;
            },

            // O Algoritmo "Greedy" de Simplificação de Dívidas
            get simplifiedDebts() {
                let balances = this.calculateBalances().map(m => ({...m})); // Clone profundo
                let transactions = [];

                // Separar devedores e credores
                let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
                let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);

                    let i = 0; // Índice devedor
                    let j = 0; // Índice credor

                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];

                        // O valor a transferir é o mínimo entre o que deve e o que tem a receber
                        let amount = Math.min(Math.abs(debtor.balance), creditor.balance);

                        // Registrar transação
                        if (amount > 0.01) {
                            transactions.push({
                                id: Date.now() + i + j,
                                from: debtor.id,
                                to: creditor.id,
                                amount: amount
                            });
                        }

                        // Atualizar saldos temporários
                        debtor.balance += amount;
                        creditor.balance -= amount;

                        // Avançar índices se liquidado
                        if (Math.abs(debtor.balance) < 0.01) i++;
                        if (creditor.balance < 0.01) j++;
                    }

                    return transactions;
                }
            }));

            Alpine.start();
    </script>
</body>
</html>